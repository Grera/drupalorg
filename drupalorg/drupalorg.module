<?php
// $Id$

/**
 * @file
 *   This module contains customizations used on drupal.org itself. It is not
 *   meant to be useful for other sites, except as an example of the kinds of
 *   modifications you can make with a site-specific module.
 */

/**
 * Vocabulary used for news forum topic tagging.
 */
define('DRUPALORG_NEWS_VID', 34);

// == Core hooks ===============================================================

/**
 * Implementation of hook_menu().
 */
function drupalorg_menu() {
  $items['documentation'] = array(
    'title' => 'Documentation',
    'page callback' => 'drupalorg_documentation',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['documentation/index'] = array(
    'title' => 'Documentation',
    'page callback' => 'drupalorg_documentation_index',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['start'] = array(
    'title' => 'Getting started with Drupal',
    'page callback' => 'drupalorg_start',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['download'] = array(
    'title' => 'Download & Extend',
    'page callback' => 'drupalorg_download',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  
  return $items;
}

// == Major landing pages ======================================================

/**
 * Page callback for the documentation page.
 *
 * @todo
 *   Add caching.
 */
function drupalorg_documentation() {
  return theme('drupalorg_documentation');
}

/**
 * Page callback for the documentation index page.
 *
 * @todo
 *   Add caching.
 */
function drupalorg_documentation_index() {
  return theme('drupalorg_documentation_index');
}

/**
 * Page callback for the getting started page.
 *
 * @todo
 *   Add caching.
 */
function drupalorg_start() {
  return theme('drupalorg_start');
}

/**
 * Implementation of template_preprocess_drupalorg_start().
 *
 * @todo
 *   Add caching.
 */
function template_preprocess_drupalorg_start(&$variables) {
  $variables['version'] = 42;

  $variables['most_popular_modules'] = theme('item_list', array(
   '<a href="#">Content construction kit (CCK)</a>', 
   '<a href="#">Views</a>', 
   '<a href="#">Gallery</a>', 
   '<a href="#">Foo bar</a>')); // Will be made dynamic, see issue #372243

  $variables['most_popular_themes'] = theme('item_list', array(
   '<a href="#">Paris Eiffel Tower</a>', 
   '<a href="#">Cute yellow ducks</a>', 
   '<a href="#">Bluecheese</a>', 
   '<a href="#">Marvin</a>'));  // Will be made dynamic, see issue #372243
}

/**
 * Page callback for the download page.
 *
 * @todo
 *   Add caching.
 */
function drupalorg_download() {
  return theme('drupalorg_download');
}

/**
 * Implementation of template_preprocess_drupalorg_download().
 *
 * @todo
 *   Add caching.
 */
function template_preprocess_drupalorg_download(&$variables) {
  $variables['version'] = 42;

  $variables['most_popular_modules'] = theme('item_list', array(
   '<a href="#">Content construction kit (CCK)</a>', 
   '<a href="#">Views</a>', 
   '<a href="#">Gallery</a>', 
   '<a href="#">Foo bar</a>')); // Will be made dynamic, see issue #372243

  $variables['most_popular_themes'] = theme('item_list', array(
   '<a href="#">Paris Eiffel Tower</a>', 
   '<a href="#">Cute yellow ducks</a>', 
   '<a href="#">Bluecheese</a>', 
   '<a href="#">Marvin</a>'));  // Will be made dynamic, see issue #372243

  $variables['most_active_modules'] = theme('item_list', array(
   '<a href="#">Content construction kit (CCK)</a>', 
   '<a href="#">Views</a>', 
   '<a href="#">Gallery</a>', 
   '<a href="#">Foo bar</a>')); 
  
  $variables['most_active_themes'] = theme('item_list', array(
   '<a href="#">Paris Eiffel Tower</a>', 
   '<a href="#">Bluecheese</a>', 
   '<a href="#">Cute yellow ducks</a>', 
   '<a href="#">Marvin</a>'));

  $variables['new_modules'] = theme('item_list', array(
   '<a href="#">Gallery</a>', 
   '<a href="#">Content construction kit (CCK)</a>', 
   '<a href="#">Views</a>', 
   '<a href="#">Foo bar</a>')); 
  
  $variables['new_themes'] = theme('item_list', array(
   '<a href="#">Cute yellow ducks</a>', 
   '<a href="#">Paris Eiffel Tower</a>', 
   '<a href="#">Bluecheese</a>', 
   '<a href="#">Marvin</a>'));

  $variables['module_categories'] = theme('item_list', array(
   '<a href="#">Gallery</a>', 
   '<a href="#">Content construction kit (CCK)</a>', 
   '<a href="#">Views</a>', 
   '<a href="#">Foo bar</a>')); 
  
  $variables['theme_categories'] = theme('item_list', array(
   '<a href="#">Cute yellow ducks</a>', 
   '<a href="#">Paris Eiffel Tower</a>', 
   '<a href="#">Bluecheese</a>', 
   '<a href="#">Marvin</a>'));
}

/**
 * Implementation of hook_theme().
 */
function drupalorg_theme() {
  return array(
    'drupalorg_documentation' => array(
      'template' => 'drupalorg-documentation',
    ),
    'drupalorg_documentation_index' => array(
      'template' => 'drupalorg-documentation-index',
    ),
    'drupalorg_start' => array(
      'template' => 'drupalorg-start',
    ),
    'drupalorg_download' => array(
      'template' => 'drupalorg-download',
    ),
  );
}

// == Altering existing behavior ===============================================

/**
 * Implementation of hook_form_alter().
 */
function drupalorg_form_alter(&$form, $form_state, $form_id) {
  // List of forms to check for overrides, and the corresponding permissions.
  $override_forms = array(
    'book_node_form'       => 'edit book pages',
    'forum_node_form'      => 'administer nodes',
    'page_node_form'       => 'administer nodes',
    'simplenews_node_form' => 'create newsletter',
    'story_node_form'      => 'administer nodes',
  );
  // Override the access for attachments if it's a forbidden form,
  // and the user does not have sufficient permissions.
  if (in_array($form_id, array_keys($override_forms)) && !user_access($override_forms[$form_id])) {
    if (isset($form['attachments']['#access'])) {
      $form['attachments']['#access'] = FALSE;
    }
  }

  // Ensure that wildcard email addresses are not abused.
  if ($form_id == 'user_register') {
    $form['#validate'][] = 'drupalorg_register_mail_validate';
  }
  
  // Core search index is not used, so clear off wipe option.
  if ($form_id == 'search_admin_settings') {
    unset($form['status']['wipe']);
  }
  
  // Add home page option to user access rule adding and editing.
  // Make sure if we edit a homepage option, we keep using that as a default.
  if ($form_id == 'user_admin_access_add_form' || $form_id == 'user_admin_access_edit_form') {
    if ($form['#parameters'][2]['type'] == 'homepage') {
      $form['type']['#default_value'] = 'homepage';
    }
    $form['type']['#options']['homepage'] = t('Homepage');
  }
  
  // Ensure nice Drupal home page addresses
  if ($form_id == 'user_profile_form') {
    $form['#validate'][] = 'drupalorg_profile_user_edit_validate';
    // Hack to make the language list a multiselect field (there is no UI
    // for this in profile module). We need to hack around that profile only
    // ever stores select field values as strings, so we need to explode what
    // was in there for our multiselect form.
    if (isset($form['Personal information']['profile_languages'])) {
      $form['Personal information']['profile_languages']['#multiple'] = TRUE;
      $form['Personal information']['profile_languages']['#default_value'] = explode('; ', $form['Personal information']['profile_languages']['#default_value']);
      $form['#submit'] = array_merge(array('drupalorg_profile_fix_languages'), $form['#submit']);
    }
  }
  
  // Force a revision log entry when editing existing book nodes.
  if ($form_id == 'book_node_form' && isset($form['revision_information']['log']) && arg(1) != 'add') {
    $form['revision_information']['log']['#required'] = TRUE;
    $form['revision_information']['#collapsed'] = FALSE;
  }
  
  // Remove the news vocabulary on forum forms, if the user is not an admin.
  // Used to mark news forum topics with tags.
  if ($form_id == 'forum_node_form') {
    $form['taxonomy'][DRUPALORG_NEWS_VID]['#access'] = user_access('administer nodes'); 
  }
}

// == User form functionality ==================================================

/**
 * Try to catch wildcard email address signups, such as joe+drupal@gmail.com.
 */
function drupalorg_register_mail_validate($form, &$form_state) {
  $hit = preg_match('/(.*)\+(.*)\@(.*)/', $form_state['values']['mail'], $match);
  if ($hit) {
    if (db_result(db_query("SELECT uid FROM {users} WHERE LOWER(mail) LIKE LOWER('%s')", $match[1] .'+%%@'. $match[3])) > 0) {
      form_set_error('mail', t('An e-mail address similar to %email is already registered. <a href="@password">Have you forgotten your password?</a>', array('%email' => $form_state['values']['mail'], '@password' => url('user/password'))));
    }
  }
}

/**
 * Validate all fields in the user_edit form against the list of bad words.
 *
 * @todo Core almost supports it with above form_alter but listings are bad
 *   (when the value is homepage, core does not know about it, so does not print it).
 * @todo Headers are blocked by some providers so this is not accurate.
 */
function drupalorg_profile_user_edit_validate($form, &$form_state) {
  if (!empty($form_state['values']['homepage']) && is_string($form_state['values']['homepage']) && (strlen($form_state['values']['homepage']) > 7)) {
    $result = db_query("SELECT mask FROM {access} WHERE type = '%s' AND status = %d", 'homepage', 0);
    $masks = array();
    while ($mask = db_fetch_object($result)) {
      // Build masks array for preg_matching.
      $masks[] = '@'. strtr($mask->mask, array('.' => '\.', '%' => '.*', '_' => '.')) .'@';
    }
    // Check denied homepages.
    foreach ($masks as $mask) {
      if (preg_match($mask, $form_state['values']['homepage'])) {
        form_set_error('homepage', t('Unsuitable Drupal site detected. This address cannot be set as your Drupal site link.'));
      }
    }
    if (!user_access('administer users')) {
      // Check for Drupal-ness of website. Try only once.
      $response = drupal_http_request($form_state['values']['homepage'], array(), 'GET', NULL, 1);
      if ($response->headers['Expires'] != 'Sun, 19 Nov 1978 05:00:00 GMT') {
        form_set_error('homepage', t("Your website does not seem to be a Drupal site. If you think we are wrong, please open an issue in the webmasters' queue."));
      }
    }
  }
}

/**
 * Submit handler for the user profile form, to serialize languages to a string.
 */
function drupalorg_profile_fix_languages(&$form, &$form_state) {
  if (is_array($form_state['values']['profile_languages'])) {
    $form_state['values']['profile_languages'] = join('; ', array_keys($form_state['values']['profile_languages']));
  }
}

// == Database replication hints ===============================================

/**
 * Implementation of hook_comment.
 */
function drupalorg_comment(&$comment, $op) {
  switch ($op) {
    case 'insert':
    case 'update':
      $_SESSION['not_slavesafe'] = TRUE;
      break;
  }
}

/**
 * Implementation of hook_nodeapi.
 */
function drupalorg_nodeapi(&$node, $op, $teaser, $page) {
  switch ($op) {
    case 'insert':
    case 'update':
      $_SESSION['not_slavesafe'] = TRUE;
  }
}

// == External search block ====================================================

/**
 * Implementation of hook_block().
 *
 * @todo Hopefully remove as part of search migration.
 */
function drupalorg_block($op = 'list', $delta = 0, $edit = array()) {
  if ($op == 'list') {
    $blocks[0] = array('info' => t('External/Alternate Search Advice (only when search is disabled)'),
      'weight' => 0, 'enabled' => 0, 'region' => 'header');
    return $blocks;
  }
  else if ($op == 'view') {
    switch ($delta) {
      case 0:
        $block = array('subject' => t('Search Engine'),
          'content' => drupalorg_display_block_external_search());
        break;
    }
    return $block;
  }
}

/**
 * Body for external search block.
 */
function drupalorg_display_block_external_search() {
  if (!user_access('search content')) {
    $form = '<form method="get" action="http://www.google.com/search"><div>
               <input type="hidden" name="ie" value="UTF-8" />
               <input type="hidden" name="oe" value="UTF-8" />
               <input type="hidden" name="domains" value="drupal.org" />
               <input type="hidden" name="sitesearch" value="drupal.org" />
               <input type="text" class="form-text" name="q" size="20" maxlength="255" value="" />
               <input type="submit" class="form-submit" name="btnG" value="Google Search" /></div>
               </form>';
    $message = '<p>Due to load issues the Drupal.org search occasionally has to be disabled.  When this happens, you can use external search engines and a modifier like "site:drupal.org" to refine your results to Drupal.  For more information <a href="http://drupal.org/node/271694">see the infrastructure queue</a></p>.';
    return $form . $message;
  }
}

// == IRC nick search ==========================================================

/**
 * Implementation of hook_search().
 *
 * Add support for searching for users based on the fixed IRC nickname field.
 *
 * @todo Possibly remove as part of search migration.
 */
function drupalorg_search($op = 'search', $keys = NULL) {
  switch ($op) {
    case 'name':
      if (user_access('access user profiles')) {
        return t('IRC nicks');
      }
    case 'search':
      if (user_access('access user profiles')) {
        $find = array();
        // Replace wildcards with MySQL/PostgreSQL wildcards.
        $keys = preg_replace('!\*+!', '%', $keys);
        $result = pager_query("SELECT u.name, u.uid FROM {profile_values} pv INNER JOIN {users} u ON pv.uid = u.uid WHERE pv.fid = 35 AND LOWER(pv.value) LIKE LOWER('%%%s%%')", 15, 0, NULL, $keys);
        while ($account = db_fetch_object($result)) {
          $find[] = array('title' => $account->name, 'link' => url('user/'. $account->uid, array('html' => TRUE)));
        }
        return $find;
      }
  }
}
