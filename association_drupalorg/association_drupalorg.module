<?php

function association_drupalorg_menu() {
  return array(
    'membership' => array(
      'title' => 'Association Memberships',
      'access arguments' => array('access content'),
      'page callback' => 'theme',
      'page arguments' => array('association_drupalorg_membership_page'),
      'type' => MENU_CALLBACK,
    ),
    'donate' => array(
      'title' => 'Donating to the Drupal Association',
      'access arguments' => array('access content'),
      'page callback' => 'theme',
      'page arguments' => array('association_drupalorg_donate_page'),
      'type' => MENU_CALLBACK,
    ),
    'membership-redirect' => array(
      'access arguments' => array('access content'),
      'page callback' => 'association_drupalorg_membership_redirect',
      'type' => MENU_CALLBACK,
    ),
  );
}

function association_drupalorg_theme() {
  return array(
    'association_drupalorg_membership_page' => array(
      'template' => 'association-drupalorg-membership-page',
    ),
    'association_drupalorg_donate_page' => array(
      'template' => 'association-drupalorg-donate-page',
    ),
  );
}

function association_drupalorg_preprocess_association_drupalorg_membership_page(&$variables) {
  $variables['individual_url'] = url('civicrm/contribute/transact', array('query' => array('reset' => 1, 'id' => 1)));
  $variables['organization_url'] = url('civicrm/contribute/transact', array('query' => array('reset' => 1, 'id' => 2)));

  if (!user_is_logged_in()) {
    $variables['individual_url'] = url('membership-redirect', array('query' => array('to' => $variables['individual_url'])));
    $variables['organization_url'] = url('membership-redirect', array('query' => array('to' => $variables['organization_url'])));
  }
  else {
    global $user;

    $variables['memberships'] = array();
    foreach (association_drupalorg_get_memberships($user) as $membership) {
      if ($membership->status === 'New' || $membership->status === 'Current') {
        $variables['memberships'][] = t('@membership_type membership expiring @date', array('@membership_type' => $membership->membership_type, '@date' => format_date(strtotime($membership->end_date), 'custom', 'M j, Y')));
      }
    }
    if (count($variables['memberships']) === 0) {
      $variables['memberships'][] = t('No current membership.');
    }
  }
}

function association_drupalorg_preprocess_association_drupalorg_donate_page(&$variables) {
  $variables['donate_url'] = url('civicrm/contribute/transact', array('query' => array('reset' => 1, 'id' => 29)));
  if (!user_is_logged_in()) {
    $variables['donate_url'] = url('membership-redirect', array('query' => array('to' => $variables['donate_url'])));
  }
}

/**
 * Set a message for the login page and redirect to it.
 */
function association_drupalorg_membership_redirect() {
  drupal_set_message(t('Please log in to buy your membership or donate.'));
  drupal_goto('user', array('destination' => preg_replace('!^' . url() . '!', '', $_REQUEST['to'])));
}

/**
 * Query CiviCRM's DB for an account's memberships.
 *
 * @param $account
 *   An account object representing the user who's membership details should be
 *   returned.
 *
 * @todo try using CiviCRM 3.4+'s API
 */
function association_drupalorg_get_memberships($account) {
  global $db_url;

  if (!is_array($db_url) || !isset($db_url['association_civicrm'])) {
    return array();
  }

  $previous_dsn = db_set_active('association_civicrm');

  $contact_id = db_result(db_query("SELECT contact_id FROM {civicrm_uf_match} WHERE uf_id = %d", $account->uid));

  // If a matching contact is found in CiviCRM.
  $membership = array();
  if ($contact_id) {
    $result = db_query("SELECT cm.id as membership_id, cm.membership_type_id, cmt.name as membership_type, cm.end_date, cms.name as status, cmb.entity_id FROM {civicrm_membership} cm LEFT JOIN {civicrm_membership_type} cmt ON cm.membership_type_id = cmt.id LEFT JOIN {civicrm_membership_status} cms ON cm.status_id = cms.id LEFT JOIN {civicrm_membership_block} cmb ON cm.membership_type_id = cmb.membership_types WHERE cm.contact_id = %d GROUP BY cm.contact_id, cm.id ORDER BY cm.end_date DESC", $contact_id);
    while ($membership = db_fetch_object($result)) {
      $memberships[] = $membership;
    }
  }

  // Change the DSN back to default Drupal $db_url.
  db_set_active($previous_dsn);

  return $memberships;
}

function association_drupalorg_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  if ($op === 'view' && $node->type === 'association_membership_benefit') {
    global $user;

    $has_membership = FALSE;
    foreach (association_drupalorg_get_memberships($user) as $membership) {
      if ($membership->status === 'New' || $membership->status === 'Current') {
        $has_membership = TRUE;
        break;
      }
    }

    if ($has_membership) {
      $node->content['field_assoc_benefit_link']['#suffix'] = '<p>' . t('Discount code: <strong>@code</strong>', array('@code' => $node->field_assoc_benefit_code[0]['value'])) . '</p>';
    }
    else {
      unset($node->content['field_assoc_benefit_link']['field']);
      $node->content['field_assoc_benefit_link']['#value'] = '<p><strong>' . l(t('Become a member!'), 'membership') . '</strong></p>';
    }

    $node->content['field_assoc_benefit_restrictions']['#weight'] = 10;
  }
}
